<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Defiende el Escudo Carbonero - Peñarol Game</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #222;
            font-family: 'Arial', sans-serif;
            color: #fff;
            flex-direction: column;
            cursor: none; /* Oculta el cursor del sistema por defecto */
        }

        /* Si el usuario elige mostrar el cursor del sistema, lo restauramos */
        body.show-system-cursor {
            cursor: default;
        }

        h1 {
            color: #ffcc00;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            text-align: center;
        }

        canvas {
            background-color: #444;
            border: 5px solid #ffcc00;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
            position: relative;
            display: none; /* Oculto por defecto */
        }

        #game-info {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0,0,0,0.7);
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1.2em;
            z-index: 10;
            display: flex;
            gap: 30px;
            pointer-events: none; /* Ignora clics para que el canvas los reciba */
        }

        /* Pantallas de juego/menú */
        .game-screen, .menu-screen {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            color: #fff;
            font-size: 1.5em;
            text-align: center;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            padding: 20px;
            box-sizing: border-box;
        }

        .menu-screen h2 {
            font-size: 2.5em;
            color: #ffcc00;
            margin-bottom: 30px;
        }
        .game-screen h2 {
            font-size: 3em;
            margin-bottom: 20px;
        }

        .menu-button, .game-button {
            background-color: #ffcc00;
            color: #000;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.2em;
            cursor: pointer;
            margin: 10px;
            transition: background-color 0.3s ease;
            min-width: 200px;
            font-weight: bold;
        }

        .menu-button:hover, .game-button:hover {
            background-color: #e6b800;
        }

        #game-over-screen h2 { color: #ff0000; }
        #win-screen h2 { color: #00ff00; }

        #peñarol-logo-final {
            width: 150px;
            height: auto;
            margin-top: 30px;
        }

        /* Mira personalizada */
        #crosshair {
            position: absolute;
            width: 20px; /* Tamaño por defecto */
            height: 20px; /* Tamaño por defecto */
            border: 2px solid #fff;
            border-radius: 50%;
            pointer-events: none; /* Permite clics a través de la mira */
            transform: translate(-50%, -50%); /* Centra la mira en el cursor */
            z-index: 1; /* Asegura que esté sobre el canvas */
            box-shadow: 0 0 5px rgba(255,255,255,0.7);
            display: none; /* Oculto hasta que el juego esté activo */
        }

        /* Estilos específicos para la pantalla de Ajustes */
        #settings-screen .setting-group {
            margin-bottom: 20px;
            text-align: left;
            width: 80%;
            max-width: 400px;
        }
        #settings-screen .setting-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        #settings-screen .setting-group select,
        #settings-screen .setting-group input[type="range"] {
            width: 100%;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ffcc00;
            background-color: #333;
            color: #fff;
            font-size: 1em;
            box-sizing: border-box;
        }
        #settings-screen .setting-group input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }
        #settings-screen p {
            font-size: 1em;
            margin-top: 5px;
            color: #ccc;
        }
        #settings-screen .buttons {
            margin-top: 30px;
        }

        /* Estilos específicos para la pantalla de Ayuda */
        #help-screen p {
            margin-bottom: 15px;
            line-height: 1.6;
            width: 80%;
            max-width: 600px;
            font-size: 1.1em;
        }
        #help-screen ul {
            text-align: left;
            width: 80%;
            max-width: 600px;
            list-style-type: disc;
            margin-left: 20px;
        }
        #help-screen li {
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <h1>Defiende el Escudo Carbonero</h1>

    <div id="start-screen" class="menu-screen">
        <h2>¡Defiende el Honor de Peñarol!</h2>
        <p>En este intenso juego, tu misión es proteger el sagrado escudo del Club Atlético Peñarol de oleadas implacables de enemigos.</p>
        <button class="menu-button" onclick="showGame()">Jugar</button>
        <button class="menu-button" onclick="showSettings()">Ajustes</button>
        <button class="menu-button" onclick="showHelp()">Ayuda</button>
        <img id="peñarol-logo-final" src="https://i.imgur.com/G9fA4Xb.jpg" alt="Peñarol Logo">
    </div>

    <div id="settings-screen" class="menu-screen">
        <h2>Ajustes del Juego</h2>

        <div class="setting-group">
            <label for="canvas-size">Tamaño de la Ventana del Juego:</label>
            <select id="canvas-size">
                <option value="900x600">Grande (900x600)</option>
                <option value="800x500">Mediano (800x500)</option>
                <option value="700x450">Pequeño (700x450)</option>
            </select>
            <p>Se aplicará al reiniciar el juego.</p>
        </div>

        <div class="setting-group">
            <label for="crosshair-size">Tamaño de la Mira:</label>
            <input type="range" id="crosshair-size" min="10" max="40" value="20">
            <p>Ajusta el tamaño visual de tu mira.</p>
        </div>

        <div class="setting-group">
            <label>
                <input type="checkbox" id="show-system-cursor-checkbox">
                Mostrar el cursor del sistema
            </label>
            <p>Marcar para ver el cursor normal del ratón junto a la mira del juego.</p>
        </div>

        <div class="buttons">
            <button class="menu-button" onclick="applySettings()">Aplicar y Volver</button>
        </div>
    </div>

    <div id="help-screen" class="menu-screen">
        <h2>¿Cómo Jugar?</h2>
        <p>¡Bienvenido, Carbonero! Tu misión es defender el escudo de Peñarol en el centro del campo de hordas de enemigos.</p>
        
        <h3>Objetivo:</h3>
        <ul>
            <li>Elimina a todos los enemigos de cada oleada antes de que el escudo reciba demasiado daño.</li>
            <li>Sobrevive a 10 oleadas para alcanzar la gloria y defender el honor Carbonero.</li>
        </ul>

        <h3>Controles:</h3>
        <ul>
            <li>**Mover la Mira:** Simplemente mueve tu ratón sobre la pantalla del juego.</li>
            <li>**Disparar:** Haz clic izquierdo con el ratón sobre un enemigo para eliminarlo.</li>
        </ul>

        <h3>Indicadores:</h3>
        <ul>
            <li>**Oleada:** Muestra la oleada actual y el total de oleadas.</li>
            <li>**Enemigos restantes:** Cuántos enemigos de la oleada actual quedan por aparecer y ser eliminados.</li>
            <li>**Escudo dañado:** Cuántos enemigos han logrado llegar al escudo en la oleada actual. Si llega al límite (indicado a la derecha), pierdes.</li>
            <li>**Puntuación:** Tu puntaje total por enemigos eliminados.</li>
        </ul>
        <button class="menu-button" onclick="showStartScreen()">Volver</button>
    </div>

    <div id="game-info">
        <div>Oleada: <span id="wave-display">1</span>/10</div>
        <div>Enemigos restantes: <span id="enemies-remaining-display">0</span></div>
        <div>Escudo dañado: <span id="shield-damage-display">0</span>/<span id="shield-limit-display">5</span></div>
        <div>Puntuación: <span id="score-display">0</span></div>
    </div>

    <canvas id="gameCanvas" width="900" height="600"></canvas>
    <div id="crosshair"></div>

    <div id="game-over-screen" class="game-screen">
        <h2>¡Game Over!</h2>
        <p>El escudo ha caído. Demasiados enemigos llegaron.</p>
        <p>Puntuación final: <span id="final-score-game-over">0</span></p>
        <button class="game-button" onclick="restartGame()">Volver a Jugar</button>
        <img id="peñarol-logo-final" src="https://i.imgur.com/G9fA4Xb.jpg" alt="Peñarol Logo">
    </div>

    <div id="win-screen" class="game-screen">
        <h2>¡VICTORIA CARBONERA!</h2>
        <p>Has defendido el escudo de Peñarol con honor y valentía.</p>
        <p>Puntuación final: <span id="final-score-win">0</span></p>
        <p>¡Eres un verdadero campeón! Celebra tu victoria con la comunidad:</p>
        <img id="peñarol-logo-final" src="https://i.imgur.com/G9fA4Xb.jpg" alt="Peñarol Community Logo">
        <p style="font-size: 1em; margin-top: 20px;">(Aquí iría un enlace real a tu comunidad Peñarol)</p>
        <button class="game-button" onclick="restartGame()">Jugar de Nuevo</button>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const crosshair = document.getElementById('crosshair');

        const startScreen = document.getElementById('start-screen');
        const settingsScreen = document.getElementById('settings-screen');
        const helpScreen = document.getElementById('help-screen');
        const gameInfo = document.getElementById('game-info');
        const gameOverScreen = document.getElementById('game-over-screen');
        const winScreen = document.getElementById('win-screen');

        const waveDisplay = document.getElementById('wave-display');
        const enemiesRemainingDisplay = document.getElementById('enemies-remaining-display');
        const shieldDamageDisplay = document.getElementById('shield-damage-display');
        const shieldLimitDisplay = document.getElementById('shield-limit-display');
        const scoreDisplay = document.getElementById('score-display');
        const finalScoreGameOver = document.getElementById('final-score-game-over');
        const finalScoreWin = document.getElementById('final-score-win');

        // Ajustes de la pantalla
        const canvasSizeSelect = document.getElementById('canvas-size');
        const crosshairSizeInput = document.getElementById('crosshair-size');
        const showSystemCursorCheckbox = document.getElementById('show-system-cursor-checkbox');

        // --- Configuración del Juego ---
        let GAME_WIDTH = 900;
        let GAME_HEIGHT = 600;
        const SHIELD_SIZE = 80;
        const ENEMY_SIZE = 20;
        const ENEMY_SPEED_BASE = 0.5;

        let enemies = [];
        let enemiesSpawnedThisWave = 0;
        let enemiesKilledThisWave = 0;
        let shieldDamage = 0;
        let currentWave = 1;
        let score = 0;
        let gameActive = false; // El juego no está activo al inicio
        let gameLoopId;
        let spawnInterval;

        const shield = {
            x: GAME_WIDTH / 2 - SHIELD_SIZE / 2,
            y: GAME_HEIGHT / 2 - SHIELD_SIZE / 2,
            width: SHIELD_SIZE,
            height: SHIELD_SIZE,
            color: '#ffcc00'
        };

        const waves = [
            { totalMobs: 50, shieldLimit: 20, spawnRate: 500 }, // Oleada 1: 2 mobs/seg (500ms)
            { totalMobs: 100, shieldLimit: 15, spawnRate: 400 }, // Oleada 2
            { totalMobs: 150, shieldLimit: 12, spawnRate: 350 }, // Oleada 3
            { totalMobs: 200, shieldLimit: 10, spawnRate: 300 }, // Oleada 4
            { totalMobs: 250, shieldLimit: 8, spawnRate: 250 }, // Oleada 5
            { totalMobs: 300, shieldLimit: 7, spawnRate: 200 }, // Oleada 6
            { totalMobs: 350, shieldLimit: 6, spawnRate: 180 }, // Oleada 7
            { totalMobs: 400, shieldLimit: 5, spawnRate: 160 }, // Oleada 8
            { totalMobs: 450, shieldLimit: 5, spawnRate: 140 }, // Oleada 9
            { totalMobs: 500, shieldLimit: 5, spawnRate: 120 }  // Oleada 10 (la más difícil)
        ];

        // --- Manejo de Pantallas ---
        function hideAllScreens() {
            startScreen.style.display = 'none';
            settingsScreen.style.display = 'none';
            helpScreen.style.display = 'none';
            gameInfo.style.display = 'none';
            gameOverScreen.style.display = 'none';
            winScreen.style.display = 'none';
            canvas.style.display = 'none';
            crosshair.style.display = 'none';
        }

        function showStartScreen() {
            hideAllScreens();
            startScreen.style.display = 'flex';
        }

        function showGame() {
            hideAllScreens();
            canvas.style.display = 'block';
            gameInfo.style.display = 'flex';
            crosshair.style.display = 'block';
            resetGame(); // Reiniciar el juego al iniciar
            startGameLoop();
            startSpawning();
        }

        function showSettings() {
            hideAllScreens();
            settingsScreen.style.display = 'flex';
            loadSettings(); // Cargar los ajustes actuales en la UI
        }

        function showHelp() {
            hideAllScreens();
            helpScreen.style.display = 'flex';
        }

        // --- Funciones de Dibujo ---
        function drawShield() {
            ctx.fillStyle = shield.color;
            ctx.fillRect(shield.x, shield.y, shield.width, shield.height);
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.strokeRect(shield.x, shield.y, shield.width, shield.height);
        }

        function drawEnemies() {
            enemies.forEach(enemy => {
                ctx.fillStyle = enemy.color;
                ctx.fillRect(enemy.x, enemy.y, ENEMY_SIZE, ENEMY_SIZE);
            });
        }

        // --- Lógica del Juego ---
        function spawnEnemy() {
            if (!gameActive) return;

            if (enemiesSpawnedThisWave >= waves[currentWave - 1].totalMobs) {
                // No spawnear más si ya se alcanzó el total para esta oleada
                return;
            }

            // Límite de enemigos en pantalla para evitar sobrecarga
            if (enemies.length >= GAME_WIDTH * GAME_HEIGHT / (ENEMY_SIZE * ENEMY_SIZE) / 20) { // Aproximadamente 5% de la pantalla
                 return; // Si hay demasiados enemigos en pantalla, espera
            }

            let startX, startY;
            const side = Math.floor(Math.random() * 4); // 0: top, 1: right, 2: bottom, 3: left

            if (side === 0) { // Top
                startX = Math.random() * GAME_WIDTH;
                startY = -ENEMY_SIZE;
            } else if (side === 1) { // Right
                startX = GAME_WIDTH;
                startY = Math.random() * GAME_HEIGHT;
            } else if (side === 2) { // Bottom
                startX = Math.random() * GAME_WIDTH;
                startY = GAME_HEIGHT;
            } else { // Left
                startX = -ENEMY_SIZE;
                startY = Math.random() * GAME_HEIGHT;
            }

            const targetX = shield.x + shield.width / 2;
            const targetY = shield.y + shield.height / 2;
            const angle = Math.atan2(targetY - startY, targetX - startX);

            enemies.push({
                x: startX,
                y: startY,
                speedX: Math.cos(angle) * (ENEMY_SPEED_BASE + (currentWave * 0.1)),
                speedY: Math.sin(angle) * (ENEMY_SPEED_BASE + (currentWave * 0.1)),
                color: '#800000'
            });
            enemiesSpawnedThisWave++;
            updateInfoDisplay(); // Actualizar contador de enemigos restantes
        }

        function startSpawning() {
            clearInterval(spawnInterval); // Limpiar cualquier intervalo anterior
            const currentWaveData = waves[currentWave - 1];
            spawnInterval = setInterval(spawnEnemy, currentWaveData.spawnRate);
        }

        function updateEnemies() {
            for (let i = enemies.length - 1; i >= 0; i--) {
                const enemy = enemies[i];
                enemy.x += enemy.speedX;
                enemy.y += enemy.speedY;

                // Colisión con el escudo
                if (enemy.x < shield.x + shield.width &&
                    enemy.x + ENEMY_SIZE > shield.x &&
                    enemy.y < shield.y + shield.height &&
                    enemy.y + ENEMY_SIZE > shield.y) {
                    
                    shieldDamage++;
                    enemies.splice(i, 1);
                    updateInfoDisplay();
                    if (shieldDamage >= waves[currentWave - 1].shieldLimit) {
                        endGame(false); // Game Over
                    }
                }
            }
        }

        function updateInfoDisplay() {
            waveDisplay.textContent = currentWave;
            enemiesRemainingDisplay.textContent = waves[currentWave - 1].totalMobs - enemiesKilledThisWave - (waves[currentWave-1].totalMobs - enemiesSpawnedThisWave);
            // Mostrar los que faltan por matar O por spawnear.
            // Más preciso: (total de mobs - (matados + dañados))
            enemiesRemainingDisplay.textContent = waves[currentWave - 1].totalMobs - (enemiesKilledThisWave + shieldDamage);

            shieldDamageDisplay.textContent = shieldDamage;
            shieldLimitDisplay.textContent = waves[currentWave - 1].shieldLimit;
            scoreDisplay.textContent = score;
        }

        function nextWave() {
            clearInterval(spawnInterval);
            enemies = [];
            enemiesSpawnedThisWave = 0;
            enemiesKilledThisWave = 0;
            shieldDamage = 0; // Resetear daño para la nueva oleada

            currentWave++;
            if (currentWave > waves.length) {
                endGame(true); // ¡Ganaste!
                return;
            }
            
            updateInfoDisplay();
            startSpawning();
        }

        function endGame(won) {
            gameActive = false;
            clearInterval(spawnInterval);
            cancelAnimationFrame(gameLoopId);
            hideAllScreens();
            if (won) {
                finalScoreWin.textContent = score;
                winScreen.style.display = 'flex';
            } else {
                finalScoreGameOver.textContent = score;
                gameOverScreen.style.display = 'flex';
            }
        }

        function resetGame() {
            gameActive = true;
            enemies = [];
            enemiesSpawnedThisWave = 0;
            enemiesKilledThisWave = 0;
            shieldDamage = 0;
            currentWave = 1;
            score = 0;
            updateInfoDisplay();
            // Asegurarse de que el escudo esté en la posición correcta según el nuevo tamaño del canvas
            shield.x = GAME_WIDTH / 2 - SHIELD_SIZE / 2;
            shield.y = GAME_HEIGHT / 2 - SHIELD_SIZE / 2;
        }

        function restartGame() {
            // Vuelve a la pantalla de inicio después de terminar el juego
            showStartScreen();
        }

        // --- Bucle Principal del Juego ---
        let lastFrameTime = 0;
        const FPS = 60;
        const frameTime = 1000 / FPS;

        function gameLoop(currentTime) {
            if (!gameActive) return;

            if (currentTime - lastFrameTime < frameTime) {
                gameLoopId = requestAnimationFrame(gameLoop);
                return;
            }
            lastFrameTime = currentTime;

            ctx.clearRect(0, 0, GAME_WIDTH, GAME_HEIGHT);

            updateEnemies();
            drawShield();
            drawEnemies();

            // Lógica para pasar a la siguiente oleada cuando todos los enemigos de la actual han sido manejados
            if (enemiesSpawnedThisWave >= waves[currentWave - 1].totalMobs && enemies.length === 0) {
                nextWave();
            }

            gameLoopId = requestAnimationFrame(gameLoop);
        }

        function startGameLoop() {
            gameLoopId = requestAnimationFrame(gameLoop);
        }

        // --- Manejo de Eventos ---
        canvas.addEventListener('mousemove', (e) => {
            if (!gameActive) return; // Solo mover mira si el juego está activo
            const rect = canvas.getBoundingClientRect();
            // Posicionar la mira directamente sobre el cursor del mouse
            crosshair.style.left = `${e.clientX - rect.left}px`;
            crosshair.style.top = `${e.clientY - rect.top}px`;
        });

        canvas.addEventListener('click', (e) => {
            if (!gameActive) return;
            const mouseX = e.clientX - canvas.getBoundingClientRect().left;
            const mouseY = e.clientY - canvas.getBoundingClientRect().top;

            for (let i = enemies.length - 1; i >= 0; i--) {
                const enemy = enemies[i];
                if (mouseX >= enemy.x && mouseX <= enemy.x + ENEMY_SIZE &&
                    mouseY >= enemy.y && mouseY <= enemy.y + ENEMY_SIZE) {
                    
                    enemies.splice(i, 1);
                    score += 10;
                    enemiesKilledThisWave++;
                    updateInfoDisplay();
                    
                    // Si todos los enemigos han sido matados o absorbidos
                    if (enemiesKilledThisWave + shieldDamage >= waves[currentWave - 1].totalMobs) {
                        if (enemiesSpawnedThisWave >= waves[currentWave - 1].totalMobs) { // Asegurarse de que todos spawnearon
                            nextWave();
                        }
                    }
                    break;
                }
            }
        });

        // --- Funciones de Ajustes ---
        function loadSettings() {
            // Cargar tamaño del canvas guardado
            const savedCanvasSize = localStorage.getItem('canvasSize');
            if (savedCanvasSize) {
                canvasSizeSelect.value = savedCanvasSize;
            }

            // Cargar tamaño de la mira guardado
            const savedCrosshairSize = localStorage.getItem('crosshairSize');
            if (savedCrosshairSize) {
                crosshairSizeInput.value = savedCrosshairSize;
                crosshair.style.width = `${savedCrosshairSize}px`;
                crosshair.style.height = `${savedCrosshairSize}px`;
            } else {
                crosshair.style.width = `20px`; // Valor por defecto
                crosshair.style.height = `20px`;
            }

            // Cargar estado del cursor del sistema
            const savedCursorSetting = localStorage.getItem('showSystemCursor');
            if (savedCursorSetting === 'true') {
                showSystemCursorCheckbox.checked = true;
                document.body.classList.add('show-system-cursor');
            } else {
                showSystemCursorCheckbox.checked = false;
                document.body.classList.remove('show-system-cursor');
            }
        }

        function applySettings() {
            // Guardar tamaño del canvas
            const selectedSize = canvasSizeSelect.value;
            const [width, height] = selectedSize.split('x').map(Number);
            localStorage.setItem('canvasSize', selectedSize);
            GAME_WIDTH = width;
            GAME_HEIGHT = height;
            canvas.width = GAME_WIDTH;
            canvas.height = GAME_HEIGHT;

            // Guardar tamaño de la mira
            const crosshairSize = crosshairSizeInput.value;
            localStorage.setItem('crosshairSize', crosshairSize);
            crosshair.style.width = `${crosshairSize}px`;
            crosshair.style.height = `${crosshairSize}px`;

            // Guardar estado del cursor del sistema
            localStorage.setItem('showSystemCursor', showSystemCursorCheckbox.checked);
            if (showSystemCursorCheckbox.checked) {
                document.body.classList.add('show-system-cursor');
            } else {
                document.body.classList.remove('show-system-cursor');
            }

            showStartScreen(); // Volver a la pantalla de inicio
            alert('Ajustes aplicados. Para el tamaño de la ventana, el juego se reiniciará completamente.');
        }

        // --- Inicio del Juego (al cargar la página) ---
        window.onload = () => {
            loadSettings(); // Cargar ajustes al inicio
            canvas.width = GAME_WIDTH; // Aplicar tamaño inicial del canvas
            canvas.height = GAME_HEIGHT;
            showStartScreen(); // Mostrar la pantalla de inicio
        };

    </script>
</body>
</html>
